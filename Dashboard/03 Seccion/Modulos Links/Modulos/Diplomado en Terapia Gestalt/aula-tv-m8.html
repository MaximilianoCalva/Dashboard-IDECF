<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diplomado en Terapia Gestalt - M8</title>
    
    <!-- PERFORMANCE & STYLES -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://player.vimeo.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: '#233878',
                        secondary: '#1e3a8a',
                        accent: '#3b82f6',
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    
    <!-- LOADER -->
    <div id="page-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
            <p class="text-sm text-gray-500 font-medium animate-pulse">Cargando lecciones...</p>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="opacity-0 transition-opacity duration-700 p-4 md:p-8 max-w-7xl mx-auto">
        
        <!-- HEADER -->
        <header class="mb-10 text-center md:text-left">
            <div class="inline-block bg-white px-4 py-1.5 rounded-full shadow-sm border border-slate-100 mb-4">
                <span class="text-xs font-bold tracking-wider text-indigo-600 uppercase">Aula Virtual</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Diplomado en Terapia Gestalt</h1>
            <p class="text-slate-500 text-lg">Módulo 8</p>
        </header>

        <!-- VIDEO PLAYER (Sticky/Main) -->
        <section class="mb-12">
            <div class="bg-black rounded-3xl shadow-2xl overflow-hidden aspect-video relative group ring-1 ring-slate-900/5">
                <iframe id="main-player" src="" class="absolute inset-0 w-full h-full" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                
                <!-- Placeholder State -->
                <div id="player-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center">
                    <div class="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mb-6 backdrop-blur-sm">
                        <svg class="w-10 h-10 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Selecciona una clase para comenzar</h3>
                    <p class="text-slate-400 max-w-md">Explora el contenido del módulo en la lista inferior y haz clic en "Reproducir" para iniciar.</p>
                </div>
            </div>
            <div id="current-playing-info" class="mt-4 hidden bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-start gap-4">
               <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path></svg>
               </div>
               <div>
                    <h3 id="playing-title" class="font-bold text-slate-800 text-lg">Titulo del Video</h3>
                    <p id="playing-desc" class="text-slate-500 text-sm mt-1">Descripcion...</p>
               </div>
            </div>
        </section>

        <!-- SEARCH -->
        <div class="mb-8 relative max-w-md">
            <input type="text" id="searchInput" placeholder="Buscar clase..." class="w-full pl-12 pr-4 py-3 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all bg-white shadow-sm">
            <svg class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>

        <!-- PLAYLIST GRID -->
        <div id="playlistItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Items injected by JS -->
        </div>

    </main>

    <script>
        // HARDCODED CONFIGURATION - ANTI-CACHE
        const CACHE_KEY = `idecf_gestalt_m8_cache`;
        const FETCH_URL = "https://script.google.com/macros/s/AKfycbxiaHxJ_MwB5x3LZy-vn8kbx1hcYVAYuQZobIB2RlyHC5as-s8nPfA5Fce3A6TAuppk/exec?type=aulatv&course=gestalt&module=8";

        (async function init() {
            try {
                // 1. Check LocalStorage
                const cached = localStorage.getItem(CACHE_KEY);
                let hasRendered = false;

                if (cached) {
                    try {
                        const parsed = JSON.parse(cached);
                        // 1 Hour validity for freshness
                        if (Date.now() - parsed.timestamp < 3600000) { 
                            console.log("Loading from cache:", CACHE_KEY);
                            processData(parsed.data);
                            hasRendered = true;
                            hideLoader();
                            // Fetch efficiently in background to update cache
                        }
                    } catch(e) { localStorage.removeItem(CACHE_KEY); }
                }

                // 2. Network Request (With Cache Buster)
                const finalUrl = FETCH_URL + "&t=" + Date.now();
                console.log("Fetching URL:", finalUrl);
                
                const response = await fetch(finalUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
                const data = await response.json();

                if (data.error) {
                     // If explicit error from server, clear cache
                     localStorage.removeItem(CACHE_KEY);
                     throw new Error(data.error);
                }

                // Update Cache and UI
                localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: data }));
                
                if (!hasRendered) {
                     processData(data);
                     hideLoader();
                }

            } catch (error) {
                console.error("Error loading data:", error);
                
                // FORCE CLEAR CACHE ON ERROR
                localStorage.removeItem(CACHE_KEY);

                if (!document.querySelector('.playlist-item')) {
                    document.getElementById('playlistItems').innerHTML = `<div class='col-span-full p-8 text-center text-red-500 bg-red-50 rounded-xl border border-red-100'>
                        <p class="font-bold mb-2">Error de Conexión</p>
                        <p class="text-sm font-mono mt-2 bg-red-50 p-2 rounded text-xs select-all text-left">
                            ${error.message}<br>
                            <span class="text-red-300">Target: ${FETCH_URL}</span>
                        </p>
                        <button onclick='location.reload(true)' class='mt-4 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200 transition-colors'>Reintentar (Limpiar Cache)</button>
                    </div>`;
                    hideLoader();
                }
            }
        })();

        function hideLoader() {
            document.getElementById('page-loader').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('main-content').classList.remove('opacity-0');
            setTimeout(() => document.getElementById('page-loader').remove(), 500);
        }

        function processData(items) {
            const grid = document.getElementById('playlistItems');
            
            if (items && items.length > 0) {
                grid.innerHTML = items.map((item, idx) => {
                    // Normalize keys
                    const title = item['Titulo'] || item['Título'] || 'Sin Título';
                    const link = item['Link'] || item['URL'] || '';
                    const desc = item['Descripcion'] || item['Descripción'] || '';
                    const num = item['Numero'] || item['N°'] || idx + 1;

                    if (!link) return ''; // Skip empty links

                    // Escape quotes for onclick
                    const safeTitle = title.replace(/'/g, "\'");
                    const safeDesc = desc.replace(/'/g, "\'");
                    
                    return `
                    <div class="playlist-item group bg-white border border-slate-200 rounded-2xl p-4 hover:shadow-xl hover:border-indigo-100 transition-all cursor-pointer flex gap-4 items-start" onclick="playVideo('${link}', '${safeTitle}', '${safeDesc}')">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center shrink-0 font-bold group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            ${num}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-800 text-sm group-hover:text-indigo-600 line-clamp-2 leading-snug mb-1">${title}</h3>
                            <p class="text-xs text-slate-400 line-clamp-1">${desc}</p>
                        </div>
                        <div class="self-center opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0">
                             <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        </div>
                    </div>`;
                }).join('');

                // Setup Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('.playlist-item').forEach(el => {
                        const text = el.innerText.toLowerCase();
                        el.style.display = text.includes(term) ? 'flex' : 'none';
                    });
                });

            } else {
                grid.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">No hay videos disponibles en este momento.</div>`;
            }
        }

        function playVideo(url, title, desc) {
            const player = document.getElementById('main-player');
            const placeholder = document.getElementById('player-placeholder');
            const info = document.getElementById('current-playing-info');
            
            let embedUrl = url;
            if (url.includes('vimeo')) {
                // Extract Vimeo ID properly even with params
                const id = url.split('/').pop().split('?')[0];
                embedUrl = `https://player.vimeo.com/video/${id}?autoplay=1`;
            } else if (url.includes('youtube') || url.includes('youtu.be')) {
                const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                embedUrl = `https://www.youtube.com/embed/${id}?autoplay=1`;
            }

            player.src = embedUrl;
            placeholder.classList.add('hidden');
            
            // Info Update
            info.classList.remove('hidden');
            document.getElementById('playing-title').innerText = title;
            document.getElementById('playing-desc').innerText = desc || 'Reproduciendo ahora...';
            
            // Smooth Scroll
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>